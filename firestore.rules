rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // User's addresses subcollection
      // Structure: users/{userId}/addresses/{addressId}
      match /addresses/{addressId} {
       allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Orders collection at root level
    // Structure: orders/{userId}/orders/{orderId}
    match /orders/{userId} {
      // Users can only access their own orders
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // User's orders subcollection
      match /orders/{orderId} {
        // Users can create their own orders
        // Allow creating orders with paymentStatus: "success", "failed", or "pending"
        allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.userId == request.auth.uid &&
                       // Validate paymentStatus if present
                       (!('paymentStatus' in request.resource.data) || 
                        request.resource.data.paymentStatus in ['success', 'failed', 'pending']);
        
        // Users can read their own orders
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // Users can update their own orders
        // Allow update only if:
        // 1. User owns the order
        // 2. Only status, paymentStatus, paymentId, razorpayOrderId, razorpaySignature, errorMessage, and updatedAt can be changed
        // 3. Status must be a valid order status (if present)
        // 4. paymentStatus must be valid (if present) - for retry scenarios
        allow update: if request.auth != null && 
                       request.auth.uid == userId &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid &&
                       // Only allowed fields can be changed
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'paymentStatus', 'paymentId', 'razorpayOrderId', 'razorpaySignature', 'errorMessage', 'updatedAt']) &&
                       // Status must be valid if present
                       (!('status' in request.resource.data) || 
                        (request.resource.data.status is string &&
                         request.resource.data.status in ['pending', 'processing', 'on the way', 'delivered', 'cancelled'])) &&
                       // paymentStatus must be valid if present
                       (!('paymentStatus' in request.resource.data) || 
                        (request.resource.data.paymentStatus is string &&
                         request.resource.data.paymentStatus in ['success', 'failed', 'pending']));
        
        // Users cannot delete orders
        allow delete: if false;
      }
    }
  }
}

