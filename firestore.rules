rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only read/write their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // User's addresses subcollection
      // Structure: users/{userId}/addresses/{addressId}
      match /addresses/{addressId} {
       allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
    
    // Orders collection at root level
    // Structure: orders/{userId}/orders/{orderId}
    match /orders/{userId} {
      // Users can only access their own orders
      allow read: if request.auth != null && request.auth.uid == userId;
      
      // User's orders subcollection
      match /orders/{orderId} {
        // Users can create their own orders
        allow create: if request.auth != null && 
                       request.auth.uid == userId &&
                       request.resource.data.userId == request.auth.uid;
        
        // Users can read their own orders
        allow read: if request.auth != null && request.auth.uid == userId;
        
        // Users can update their own orders (for cancelling - status updates only)
        // Allow update only if:
        // 1. User owns the order
        // 2. Only status and updatedAt fields can be changed
        // 3. Status must be a valid order status
        allow update: if request.auth != null && 
                       request.auth.uid == userId &&
                       resource.data.userId == request.auth.uid &&
                       request.resource.data.userId == request.auth.uid &&
                       // Only status and updatedAt can be changed
                       request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'updatedAt']) &&
                       // Status must be valid
                       request.resource.data.status is string &&
                       request.resource.data.status in ['pending', 'processing', 'on the way', 'delivered', 'cancelled'];
        
        // Users cannot delete orders
        allow delete: if false;
      }
    }
  }
}

